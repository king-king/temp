<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>5.0.4</title>
    <style>
        * {
            font-family: "微软雅黑", sans-serif;
        }

        .hide {
            display: none !important;
        }

        .top-btn {
            width: 100px;
            height: 50px;
            position: absolute;
            top: 20px;
            cursor: pointer;
            -webkit-user-select: none;
        }

        .msg-box {
            position: absolute;
            width: 151px;
            left: 50%;
            top: 50%;
            -webkit-transform: translate3d(-50%, -50%, 0);
            padding: 20px;
            border-radius: 5px;
            background-color: orangered;
            color: #fff;
            display: inline-block;
            bottom: auto !important;
            text-align: center;
            z-index: 1000;
        }

        .msg-box.remove {
            display: none !important;
        }

        .act {
            left: 20%;
            background: url("img/preview-symbol.png") no-repeat center center;
            background-size: contain;
            -webkit-transform: translate3d(0, -200px, 0);
        }

        .act.doing, .act:hover {
            background: url("img/preview-symbol-hover.png") no-repeat center center;
            background-size: contain;
        }

        .download {
            left: 30%;
            background: url("img/download-symbol.png") no-repeat center center;
            background-size: auto 35px;
            -webkit-transform: translate3d(0, -200px, 0);
        }

        .download:hover {
            background: url("img/download-symbol-hover.png") no-repeat center center;
            background-size: auto 35px;
        }

        .save {
            left: 40%;
            background: url("img/save-symbol.png") no-repeat center center;
            background-size: auto 35px;
            -webkit-transform: translate3d(0, -200px, 0);
        }

        .save:hover {
            background: url("img/save-symbol-hover.png") no-repeat center center;
            background-size: auto 35px;
        }

        .import-data {
            left: 50%;
            background: url("img/importdata-symbol.png") no-repeat center center;
            background-size: auto 35px;
            -webkit-transform: translate3d(0, -200px, 0);
        }

        .import-data:hover {
            background: url("img/importdata-symbol-hover.png") no-repeat center center;
            background-size: auto 35px;
        }

        .change {
            left: 60%;
            background: url("img/change-symbol.png") no-repeat center center;
            background-size: auto 35px;
            -webkit-transform: translate3d(0, -200px, 0);
        }

        .change:hover {
            background: url("img/change-symbol-hover.png") no-repeat center center;
            background-size: auto 35px;
        }

        .show .act {
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-transition: .3s cubic-bezier(.07, .84, .67, 1.24);
        }

        .show .download {
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-transition: .3s cubic-bezier(.07, .84, .67, 1.24) 0.05s;
        }

        .show .save {
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-transition: .3s cubic-bezier(.07, .84, .67, 1.24) 0.1s;
        }

        .show .import-data {
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-transition: .3s cubic-bezier(.07, .84, .67, 1.24) 0.15s;
        }

        .show .change {
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-transition: .3s cubic-bezier(.07, .84, .67, 1.24) 0.2s;
        }

        .phone-border {
            width: 320px;
            height: 480px;
            border: 10px solid #555;
            border-radius: 2px;
            position: absolute;
            top: 0;
            left: 3%;
            overflow: hidden;
            -webkit-transform: scale(0);
        }

        .phone-border img.page {
            width: 100%;
            -webkit-user-select: none;
        }

        .phone-border img.custom-plugin {
            width: auto;
        }

        .cur-plugin {
            width: 200px;
            height: 500px;
            border: 3px solid #ddd;
            overflow-x: hidden;
            overflow-y: auto;
            position: absolute;
            left: 30%;
            top: 0;
            box-sizing: border-box;
            -webkit-transform: scale(0);
        }

        .cur-plugin .title, .add-plugin .title, .add-custom-plugin .title, .config .title, .select-page-filter .title {
            width: 100%;
            height: 20px;
            line-height: 20px;
            text-align: center;
        }

        .cur-plugin .item {
            width: 100%;
            height: 25px;
            line-height: 25px;
            color: #aaa;
            border-bottom: 1px solid #eee;
            text-align: left;
            padding: 0 10px;
            box-sizing: border-box;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
        }

        .cur-plugin .item .delete-item {
            width: 21px;
            height: 21px;
            position: absolute;
            right: 5px;
            color: red;
            text-align: center;
            line-height: 20px;
            font-size: 18px;
            top: 2px;
            display: none;
        }

        .cur-plugin .item.select .delete-item {
            display: block;
        }

        .cur-plugin .item.select {
            background-color: #eee;
            color: #999;
        }

        .add-plugin {
            width: 300px;
            height: 60px;
            border: 3px solid #ddd;
            position: absolute;
            left: 47%;
            top: 358px;
            box-sizing: border-box;
            -webkit-transform: scale(0);
        }

        .add-plugin .plugins {
            display: inline-block;
            width: 100%;
            height: 30px;
            border: 0;
        }

        .add-plugin .plugins option {
            text-align: center;
        }

        .add-custom-plugin {
            width: 300px;
            height: 50px;
            border: 3px solid #ddd;
            position: absolute;
            left: 47%;
            bottom: 0;
            -webkit-transform: scale(0);
            box-sizing: border-box;
        }

        .add-custom-plugin .select-file {
            height: 26px;
            line-height: 26px;
            text-align: center;
            background: dodgerblue;
            color: #fff;
            cursor: pointer;
        }

        .config {
            width: 300px;
            height: 500px;
            border: 3px solid #ddd;
            position: absolute;
            left: 70%;
            top: 0;
            padding: 0 10px;
            box-sizing: border-box;
            overflow-y: hidden;
            -webkit-transform: scale(0);
        }

        .select-page-filter {
            width: 300px;
            height: 50px;
            border: 3px solid #ddd;
            position: absolute;
            left: 47%;
            top: 550px;
        }

        .phone-border img {
            position: absolute;
        }

        .phone-border .bubble-hearts {
            bottom: 0;
            top: auto !important;
        }

        .half-opacity {
            opacity: 0.5 !important;
            border: 2px solid deepskyblue;
        }

        .config-plugin {
            width: 300px;
            height: 330px;
            border: 3px solid #ddd;
            position: absolute;
            left: 47%;
            top: 0;
            padding: 0 10px;
            box-sizing: border-box;
            -webkit-transform: scale(0);
        }

        .filter .select-filter {
            display: inline-block;
            width: 200px;
            height: 30px;
            border: 0;
        }

        .config .save-frame {
            height: 30px;
            line-height: 30px;
            color: #fff;
            font-size: 28px;
            text-align: center;
            cursor: pointer;
            margin: 10px 0;
            background: lightskyblue url("img/save-frame.png") no-repeat center center;
            background-size: 20px;
        }

        .config .add-frame {
            height: 30px;
            line-height: 30px;
            color: #fff;
            background-color: #e95d5d;
            font-size: 28px;
            text-align: center;
            cursor: pointer;
            margin: 10px 0;
        }

        .frames-border {
            height: 350px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 20px;
        }

        .config .delay {
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .frames-border .frame-item {
            padding: 10px 0;
            overflow: visible;
            position: relative;
        }

        .frames-border .frame-item:nth-child(2n) {
            background-color: #efefef;
        }

        .frames-border .frame-item .property {
            margin-bottom: 5px;
        }

        .delete-border {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50px;
            right: -30px;
            cursor: pointer;
        }

        .delete.frame-item {
            -webkit-transform: translate3d(-30px, 0, 0);
            -webkit-transition: .3s cubic-bezier(.15, .76, .49, .91);
        }

        .delete-border .delete-btn {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30px;
            right: 0;
            background-color: #e95d5d;
            color: #fff;
            line-height: 188px;
            text-align: center;
        }

        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate3d(-50%, -50%, 0);
            width: 150px;
            text-align: center;
            background-color: #555;
            color: #fff;
            border-radius: 5px;
            z-index: 1000;
            padding: 20px;
            box-shadow: #555 2px 2px 20px;
            -webkit-user-select: none;
            word-break: break-all;
        }

        .content-border {
            width: 100%;
            height: 500px;
            position: absolute;
            left: 0;
            top: 50%;
            -webkit-transform: translate3d(0, -50%, 0);
        }

        .show .phone-border {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) forwards;
        }

        .show .cur-plugin {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) 0.05s forwards;
        }

        .show .config-plugin {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) 0.1s forwards;
        }

        .show .add-plugin {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) 0.15s forwards;
        }

        .show .add-custom-plugin {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) 0.2s forwards;
        }

        .show .config {
            -webkit-animation: show .3s cubic-bezier(.07, .84, .67, 1.24) 0.25s forwards;
        }

        @-webkit-keyframes show {
            0% {
                -webkit-transform: scale(0);
                -webkit-transform-origin: 50% 0;
            }
            100% {
                -webkit-transform: scale(1);
                -webkit-transform-origin: 50% 0;
            }
        }

        .net-status {
            position: absolute;
            height: 30px;
            width: 100px;
            top: 10px;
            right: 10px;
            font-family: "微软雅黑", sans-serif;
            font-size: 14px;
        }

        .net-status div {
            float: left;
        }

        .net-status .light {
            width: 10px;
            height: 10px;
            border-radius: 10px;
            margin-top: 5px;
            margin-right: 5px;
        }

        .net-status .online {
            color: green;
        }

        .net-status.on-offline .online {
            display: none;
        }

        .net-status .offline {
            color: red;
        }

        .net-status.on-online .offline {
            display: none;
        }

        .net-status.on-offline .light {
            background-color: red;
        }

        .net-status.on-online .light {
            background-color: green;
        }
    </style>
</head>
<body>
<div class="act top-btn" title="预览"></div>
<div class="download top-btn" title="导出数据"></div>
<div class="save top-btn" title="保存"></div>
<div class="import-data top-btn" title="导入数据"></div>
<div class="change top-btn" title="切换到其他"></div>

<div class="net-status on-online">
    <div class="light"></div>
    <div class="online">在线</div>
    <div class="offline">离线</div>
</div>

<div class="content-border">
    <input type="file" class="content-border-file-input hide" accept=".png,.jpeg,.jpg">
    <div class="phone-border">
        <img src="img/page3.jpg" class="page" style="cursor:pointer">
    </div>

    <!--显示当前页面中都有什么组件-->
    <div class="cur-plugin">
        <div class="title">页面&组件</div>
        <div class="page-item item select">page</div>
    </div>

    <div class="config-plugin">
        <div class="title">配置组件属性</div>
        <div class="x">x:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text"> (px)</div>
        <br>
        <div class="y">y:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text"> (px)</div>
        <br>
        <div class="h">h:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text"> (px)</div>
        <br>
        <div class="rotate">rotate:&nbsp;&nbsp;&nbsp;<input type="text"> (deg)</div>
        <br>
        <div class="opacity">opacity:&nbsp;<input type="text"></div>
        <br>
        <div class="delay">delay:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text"> s</div>
        <br>
        <div class="filter">filter:&nbsp;&nbsp;&nbsp;
            <select class="select-filter">
                <option value="none">无</option>
                <option value="black-white">黑白</option>
                <option value="older">怀旧</option>
                <option value="blur">模糊</option>
                <option value="flower">花样</option>
                <option value="hard">强烈</option>
                <option value="sobel">线条</option>
                <option value="filter-dull">磨砂</option>
            </select></div>
        <br>
    </div>

    <div class="add-plugin">
        <div class="title">添加已有组件</div>
        <select class="plugins">
        </select>
    </div>

    <div class="add-custom-plugin">
        <div class="title">添加自定义组件</div>
        <form><input type="file" class="hide" accept=".png"></form>
        <div class="select-file">选择图片</div>
    </div>

    <div class="config">
        <div class="title">配置组件动画帧</div>
        <div class="save-frame" title="保存"></div>
        <div class="add-frame" title="添加帧">＋</div>
        <div class="frames-border"></div>
    </div>
</div>


<script src="../../lib/zach/client.js"></script>
<script>
    main( function () {
        // api
        var debug = imports( "../debug.js" ),
                widget = imports( "../widget" ),
                $ = imports( "element" ),
                ua = imports( "ua" ),
                css = imports( "css" ),
                cinema = imports( "./cinema-parse.js" ),
                object = imports( "object" ),
                array = imports( "array" ),
                querySelector = document.querySelector.bind( document ),
                querySelectorAll = document.querySelectorAll.bind( document );

        // dom
        var body = querySelector( ".phone-border" ),
                pluginsBorder = querySelector( ".cur-plugin" ),
                addCustomPlugin = querySelector( ".add-custom-plugin .select-file" ),
                inputFile = querySelector( ".add-custom-plugin input" ),
                configFramesBorder = querySelector( ".config" ),
                systemPluginSelect = querySelector( ".add-plugin .plugins" ),
                downloadBtn = querySelector( ".download" ),
                frameBorder = querySelector( ".frames-border" ),
                pageItem = querySelector( ".cur-plugin .page-item" ),
                page = querySelector( ".page" ),
                net_status = querySelector( ".net-status" );


        window.addEventListener( "offline", function () {
            net_status.classList.remove( "on-online" );
            net_status.classList.add( "on-offline" );
        }, false );

        window.addEventListener( "online", function () {
            net_status.classList.add( "on-online" );
            net_status.classList.remove( "on-offline" );
        }, false );


        // template
        var frameTemplate =
                "<div class='property x'>x:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='text'></div>" +
                "<div class='property y'>y:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='text'></div>" +
                "<div class='property scale'>scale:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='text'>(>1)</div>" +
                "<div class='property opacity'>opacity:&nbsp;&nbsp;&nbsp;<input type='text'>(0~1)</div>" +
                "<div class='property duration'>duration:&nbsp;<input type='text'>&nbsp;s</div>" +
                "<div class='property rotate'>rotate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='text'>(deg)</div>" +
                "<div class='delete-border'><div class='delete-btn'>删</div></div>";

        // data module存放控件数据的
        window._data = {};

        // 模拟数据
        window.body = body;
        window.clientWidth = 320;
        window.clientHeight = 480;

        // 当前作品名称，如果为空的话，在保存的时候需要起名字，如果不为空说明是修改。
        var curZuoPinName = null;

        // config data
        var sysPlugin = [
            {
                title : "桃心组动画",
                notSupportAttr : ["x", "h", "rotate", "frames", "opacity", "filter"],
                src : "plugin-hearts"
            },
            {
                title : "冒桃心",
                notSupportAttr : ["x", "h", "y", "rotate", "frames", "opacity", "filter"],
                src : "bubble-hearts"
            }
        ];

        var _dataMap = {};

        var changePageFile = querySelector( ".content-border-file-input" );

        querySelector( ".phone-border .page" ).onclick = function () {
            changePageFile.click();
        };

        changePageFile.onchange = function () {
            page.src = window.URL.createObjectURL( changePageFile.files[0] );
        };

        // 首先获取已有的组件
        (function () {
            var xhr = new XMLHttpRequest();
            xhr.open( "get", "http://" + location.hostname + ":7474/get-plugin-list", true );
            xhr.send();
            xhr.onreadystatechange = function () {
                if ( xhr.readyState == 4 && xhr.status == 200 ) {
                    var data = JSON.parse( xhr.responseText ).message;
                    array.foreach( data, function ( d ) {
                        sysPlugin.push( {
                            title : d.alias,
                            notSupportAttr : [],
                            src : d.name
                        } )
                    } );
                    array.foreach( sysPlugin, function ( plugin ) {
                        _dataMap[plugin.src] = plugin;
                    } );

                    // 设定添加系统组件
                    array.foreach( sysPlugin, function ( plugin ) {
                        var option = $( "option", {
                            innerHTML : plugin.title,
                            value : plugin.src
                        }, systemPluginSelect );
                        systemPluginSelect.onchange = function () {
                            var name = systemPluginSelect.selectedOptions[0].innerHTML, curPlugin;
                            for ( var i = 0; i < sysPlugin.length; i++ ) {
                                if ( name == sysPlugin[i].title ) {
                                    curPlugin = sysPlugin[i];
                                    break;
                                }
                            }
                            addPluginFunc( curPlugin );
                        }
                    } );
                }
            }
        })();


        // 模拟操作
        page.toCanvas = function () {
            var canvas = document.createElement( "canvas" );
            var naw = page.naturalWidth,
                    w = clientWidth,
                    h = clientHeight;
            canvas.width = w;
            canvas.height = h;
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            canvas.getContext( "2d" ).drawImage( this, 0, 0, naw, naw / w * h, 0, 0, w, h );
            return canvas;
        };

        // tools
        function message( mess ) {
            var border = $( "div", {classList : "message-box", innerHTML : mess}, document.body );
            var isRemove = false;
            setTimeout( function () {
                border.parentNode.removeChild( border );
                border = null;
                isRemove = true;
            }, 2000 );
            return {
                change : function ( text ) {
                    if ( !isRemove ) {
                        border.innerHTML = text;
                    }
                }
            }
        }

        useBrowserConsole();

        addCustomPlugin.onclick = function () {
            inputFile.click();
        };

        function getFileName( str ) {
            return str.slice( 0, str.indexOf( "." ) );
        }

        // 处理页面&组件中的page项目
        function processPageItem() {
            var x = querySelector( ".config-plugin .x input" ),
                    y = querySelector( ".config-plugin .y input" ),
                    h = querySelector( ".config-plugin .h input" ),
                    rotate = querySelector( ".config-plugin .rotate input" ),
                    opacity = querySelector( ".config-plugin .opacity input" ),
                    delay = querySelector( ".config-plugin .delay input" ),
                    filter = querySelector( ".config-plugin .filter select" );

            function limit() {
                x.disabled = true;
                y.disabled = true;
                h.disabled = true;
                rotate.disabled = true;
                opacity.disabled = true;
                filter.disabled = false;
                x.value = y.value = h.value = rotate.value = opacity.value = "~";
            }

            limit();
            delay.value = 0;
            pageItem.wid = (new Date()).getTime();
            _data[pageItem.wid] = {
                "filter" : null,// 只有page才有滤镜，才有这项。
                name : "page",
                delay : 0,
                frames : []
            };
            pageItem.onclick = function () {
                configFramesBorder.classList.remove( "hide" );
                var cur = body.querySelector( ".custom-plugin.half-opacity" );
                cur && cur.classList.remove( "half-opacity" );
                var curItem = pluginsBorder.querySelector( ".item.select" );
                curItem && curItem.classList.remove( "select" );
                pageItem.classList.add( "select" );
                clearAllPluginAttrLimit();
                frameBorder.innerHTML = "";
                limit();
                delay.value = _data[pageItem.wid].delay;
                setFrames( pageItem.wid );
                /*todo:读取动画帧数据并显示*/
            }
        }

        processPageItem();

        function clearAllPluginAttrLimit() {
            var x = querySelector( ".config-plugin .x input" ),
                    y = querySelector( ".config-plugin .y input" ),
                    h = querySelector( ".config-plugin .h input" ),
                    rotate = querySelector( ".config-plugin .rotate input" ),
                    delay = querySelector( ".config-plugin .delay input" ),
                    opacity = querySelector( ".config-plugin .opacity input" ),
                    filter = querySelector( ".config-plugin .filter select" );
            x.disabled = y.disabled = h.disabled = rotate.disabled = opacity.disabled = delay.disabled = filter.disabled = false;
        }

        function setFrames( id ) {
            frameBorder.innerHTML = "";
            /*读取动画帧数据并显示*/
            array.foreach( _data[id].frames, function ( frame ) {
                var item = $( "div", {classList : "frame-item", innerHTML : frameTemplate}, frameBorder ),
                        deleteBorder = item.querySelector( ".delete-border" ),
                        deleteBtn = item.querySelector( ".delete-btn" );
                deleteBtn.onclick = function () {
                    item.parentNode.removeChild( item );
                    item = null;
                    // 删除动画帧的时候不会去删数据，采取的策略是保存的时候覆盖掉原来的数据
                };
                deleteBorder.onmouseover = function () {
                    item.classList.add( "delete" );
                };
                deleteBorder.onmouseout = function () {
                    item.classList.remove( "delete" );
                };
                item.querySelector( ".x input" ).value = frame.x;
                item.querySelector( ".y input" ).value = frame.y;
                item.querySelector( ".scale input" ).value = frame.scale;
                item.querySelector( ".opacity input" ).value = frame.opacity;
                item.querySelector( ".duration input" ).value = frame.duration;
                item.querySelector( ".rotate input" ).value = frame.rotate;
            } );
        }

        function addPluginFunc( info, importData, alias ) {
            var cur = body.querySelector( ".custom-plugin.half-opacity" );
            cur && cur.classList.remove( "half-opacity" );
            var curItem = pluginsBorder.querySelector( ".item.select" );
            curItem && curItem.classList.remove( "select" );
            frameBorder.innerHTML = "";
            var x = querySelector( ".config-plugin .x input" ),
                    y = querySelector( ".config-plugin .y input" ),
                    h = querySelector( ".config-plugin .h input" ),
                    rotate = querySelector( ".config-plugin .rotate input" ),
                    opacity = querySelector( ".config-plugin .opacity input" ),
                    delay = querySelector( ".config-plugin .delay input" ),
                    filter = querySelector( ".config-plugin .filter select" );
            var item;
            var img;
            if ( !importData || importData.name != "page" ) {
                img = $( "img", {
                    classList : ["custom-plugin", "half-opacity", (info && info.src) ? info.src : ( importData && importData.name ? importData.name : alias)],
                    src : (info && "img/plugin/" + info.src + ".png" ) || window.URL.createObjectURL( inputFile.files[0] )
                }, body );
                item = $( "div", {
                    classList : ["item", "select"],
                    innerHTML : (info && info.title) || alias
                }, pluginsBorder );
                // 选中组件
                item.onclick = function () {
                    configFramesBorder.classList.remove( "hide" );
                    checkLimit();
                    filter.disabled = true;// 手工添加的组件全都不能附加滤镜
                    var cur = body.querySelector( ".custom-plugin.half-opacity" );
                    cur && cur.classList.remove( "half-opacity" );
                    var curItem = pluginsBorder.querySelector( ".item.select" );
                    curItem && curItem.classList.remove( "select" );
                    item.classList.add( "select" );
                    img.classList.add( "half-opacity" );
                    // 显示属性数据
                    x.value = _data[item.wid].x;
                    y.value = _data[item.wid].y;
                    h.value = _data[item.wid].h;
                    rotate.value = _data[item.wid].rotate;
                    delay.value = _data[item.wid].delay;
                    opacity.value = _data[item.wid].opacity;
                    setFrames( item.wid );
                };

                var deleteBtn = $( "div", {classList : "delete-item", innerHTML : "x"}, item );
                // 删掉一个控件，不仅要删掉dom，还要删掉_data中的数据
                deleteBtn.onclick = function ( e ) {
                    e.stopPropagation();
                    // 删掉dom元素
                    item.parentNode.removeChild( item );
                    img.parentNode.removeChild( img );
                    // 删数据
                    delete _data[item.wid];
                    item = deleteBtn = null;
                    // 删掉动画帧,自动显示pageItem的帧动画
                    frameBorder.innerHTML = "";
                    pageItem.click();
                };
            }
            // addPluginFunc函数不仅可以生成组件，还可以按照导入的数据生成组件
            filter.disabled = true;// 手工添加的组件全都不能附加滤镜
            var wid;
            if ( importData ) {
                wid = importData.wid;
                if ( importData.name == "page" ) {
                    filter.disabled = false;
                    item = pageItem;
                    _data[wid] = {
                        name : "page",
                        delay : importData.delay,
                        opacity : importData.opacity,
                        frames : importData.frames,
                        filter : importData.filter
                    };
                }
                else {
                    /*
                     importData中的x、y、h可能是数字（旧数据导致的），也可能是字符串。
                     如果是字符串的话，可能是这种情况"w-50"这种形式，所以判断一下，用eval函数取数据
                     * */
                    _data[wid] = {
                        name : info.src,
                        delay : importData.delay,
                        x : importData.x,
                        y : importData.y,
                        h : importData.h,
                        rotate : importData.rotate,
                        opacity : importData.opacity,
                        frames : importData.frames
                    };
                    array.foreach( ["x", "y", "h"], function ( key ) {
                        if ( object.is.String( importData[key] ) ) {
                            try {
                                var w = clientWidth, h = clientHeight;
                                importData[key] = eval( importData[key] );
                            }
                            catch ( e ) {
                                console.warn( "组件" + importData.name + "的" + key + "属性有误" );
                                importData[key] = 0;
                            }
                        }
                    } );

                    css( img, {
                        "left" : importData.x < 1 && importData.x > -1 ? importData.x * 100 + "%" : importData.x + "px",
                        "top" : importData.y < 1 && importData.y > -1 ? importData.y * 100 + "%" : importData.y + "px",
                        "height" : importData.h < 1 && importData.h > -1 ? importData.h * 100 + "%" : importData.h + "px",
                        "opacity" : importData.opacity,
                        "-webkit-transform" : "rotateZ(" + importData.rotate + "deg)"
                    } );
                }
            }
            else {
                // 每个控件都有一个id（是个时间戳），为了修改数据用
                wid = (new Date()).getTime();
                _data[wid] = {
                    name : (info && info.src) || getFileName( inputFile.files[0].name ),
                    delay : 0,
                    x : 0,
                    y : 0,
                    h : 0,
                    rotate : 0,
                    opacity : 1,
                    frames : []
                };
                img.onload = function () {
                    _data[wid].h = h.value = img.naturalHeight;
                };
                rotate.value = y.value = x.value = delay.value = 0;
                opacity.value = 1;
            }

            item.wid = wid;
            configFramesBorder.classList.remove( "hide" );

            function checkLimit() {
                var disabledAttr = {
                    "x" : function () {
                        x.disabled = true;
                    },
                    "y" : function () {
                        y.disabled = true;
                    },
                    "h" : function () {
                        h.disabled = true;
                    },
                    "rotate" : function () {
                        rotate.disabled = true;
                    },
                    "frames" : function () {
                        configFramesBorder.classList.add( "hide" );
                    },
                    "opacity" : function () {
                        opacity.disabled = true;
                    },
                    "filter" : function () {
                        filter.disabled = true;
                    }
                };
                clearAllPluginAttrLimit();
                info && info.notSupportAttr && array.foreach( info.notSupportAttr, function ( n ) {
                    disabledAttr[n]();
                } );
            }

            checkLimit();
        }

        // 设定添加自定义组件
        inputFile.onchange = function () {
            var alias = prompt( "起个名字吧" );
            var wall = $( "div", {
                css : {
                    position : "absolute",
                    top : 0,
                    left : 0,
                    right : 0,
                    bottom : 0,
                    "z-index" : 200,
                    "background" : "rgba(0,0,0,0.98)"
                }
            }, document.body );
            if ( alias && alias.trim().length != 0 ) {
                // 名字起好了，上传~！
                var fd = new FormData();
                fd.append( "wq-file", inputFile.files[0] );
                fd.append( "alias", alias.trim() );
                var xhr = new XMLHttpRequest();
                xhr.open( "post", "http://" + location.hostname + ":7474/upload", true );
                xhr.send( fd );
                xhr.onreadystatechange = function () {
                    if ( xhr.readyState == 4 && xhr.status == 200 ) {
                        var data = JSON.parse( xhr.responseText );
                        document.body.removeChild( wall );
                        wall = null;
                        alert( data.message );
                        if ( data.code == 200 ) {
                            addPluginFunc( null, null, alias );
                        }
                        else {
                            alert( data.message );
                        }
                    }
                };
                xhr.onerror = function () {
                    document.body.removeChild( wall );
                    wall = null;
                    alert( "网络故障" );
                };
            }
        };

        // 调试组件属性
        (function () {
            var x = querySelector( ".config-plugin .x input" ),
                    y = querySelector( ".config-plugin .y input" ),
                    h = querySelector( ".config-plugin .h input" ),
                    rotate = querySelector( ".config-plugin .rotate input" ),
                    opacity = querySelector( ".config-plugin .opacity input" ),
                    delay = querySelector( ".config-plugin .delay input" ),
                    filter = querySelector( ".config-plugin .filter .select-filter" );

            rotate.oninput = x.oninput = y.oninput = h.oninput = opacity.oninput = delay.oninput = function () {
                var curItem = querySelector( ".cur-plugin .item.select" ),
                        curImg = querySelector( ".phone-border img.half-opacity" ),
                        curId = curItem.wid;

                var h = clientHeight,
                        w = clientWidth;   // 不可删除，在eval中使用到了

                try {
                    var data = eval( this.value );
                }
                catch ( e ) {
                    data = null;
                }

                if ( this.parentNode.classList.contains( "x" ) ) {
                    _data[curId].x = this.value;
                    curImg && css( curImg, {"left" : data < 1 && data > -1 ? data * 100 + "%" : data + "px"} );
                }
                else if ( this.parentNode.classList.contains( "y" ) ) {
                    _data[curId].y = this.value;
                    curImg && css( curImg, {"top" : data < 1 && data > -1 ? data * 100 + "%" : data + "px"} );
                }
                else if ( this.parentNode.classList.contains( "h" ) ) {
                    _data[curId].h = this.value;
                    curImg && css( curImg, {"height" : data < 1 && data > -1 ? data * 100 + "%" : data + "px"} );
                }
                else if ( this.parentNode.classList.contains( "delay" ) ) {
                    _data[curId].delay = data;
                }
                else if ( this.parentNode.classList.contains( "rotate" ) ) {
                    _data[curId].rotate = data;
                    curImg && css( curImg, {"-webkit-transform" : "rotateZ(" + data + "deg)"} );
                }
                else if ( this.parentNode.classList.contains( "opacity" ) ) {
                    _data[curId].opacity = data;
                    curImg && css( curImg, {opacity : data} );
                }
            };

            filter.onchange = function () {
                var curItem = querySelector( ".cur-plugin .item.select" ),
                        curId = curItem.wid;
                _data[curId].filter = filter.selectedOptions[0].value;
            }
        })();

        // 操作动画帧
        (function () {
            var addFrameBtn = querySelector( ".config .add-frame" ),
                    saveBtn = querySelector( ".config .save-frame" );
            addFrameBtn.onclick = function () {
                var item = $( "div", {classList : "frame-item", innerHTML : frameTemplate}, frameBorder ),
                        deleteBorder = item.querySelector( ".delete-border" ),
                        deleteBtn = item.querySelector( ".delete-btn" );
                deleteBtn.onclick = function () {
                    item.parentNode.removeChild( item );
                    item = null;
                    // 删除动画帧的时候不会去删数据，采取的策略是保存的时候覆盖掉原来的数据
                };
                deleteBorder.onmouseover = function () {
                    item.classList.add( "delete" );
                };
                deleteBorder.onmouseout = function () {
                    item.classList.remove( "delete" );
                };
            };

            // 点击保存按钮，用当前的动画帧把原始数据中的覆盖掉
            saveBtn.onclick = function () {
                var me = message( "saving...." );
                setTimeout( function () {
                    me.change( "ok..." );
                }, 1000 );
                var frames = [];
                array.foreach( frameBorder.querySelectorAll( ".frame-item" ), function ( item, i ) {
                    frames.push( {
                        x : item.querySelector( ".x input" ).value,
                        y : item.querySelector( ".y input" ).value,
                        scale : parseFloat( item.querySelector( ".scale input" ).value ),
                        opacity : parseFloat( item.querySelector( ".opacity input" ).value ),
                        duration : parseFloat( item.querySelector( ".duration input" ).value ),
                        rotate : parseFloat( item.querySelector( ".rotate input" ).value )
                    } )
                } );
                // todo:需要考虑今后要不要在这里加上对动画帧是否合法的验证
                // 通过得到当前选中的组件得到得到id
                var curId = querySelector( ".cur-plugin .item.select" ).wid;
                _data[curId].frames = frames;
                // todo:今后可能会添加如果没保存则更换组件时候会弹出提示
            };

        })();

        // 导出内容
        (function () {
            // todo:或许以后这部分会改成链接数据库的，可以自动将配置信息持久化，目前还是按照手动拷贝的方式
            downloadBtn.onclick = function () {
                var dataWindow = window.open( "" );
                dataWindow.document.write( "<html><head><title>导出的数据</title><style>textarea{width: 100%;height: 100%;font-size: 25px;  font-family: '微软雅黑';color: darkblue;}</style></head><body><textarea>" + JSON.stringify( _data ) + "</textarea></body></html>" );
            };
        })();

        document.body.onload = function () {
            document.body.classList.add( "show" );
        };

        function resetByData( data ) {
            // todo:这里的代码比较关键，依靠数据生成页面。目前这里的数据是手工输入，以后可能会添加从数据库获取的途径，处理的方法是一致的
            // 删掉现有的自定义组件
            var customPlugins = querySelectorAll( ".custom-plugin" );
            customPlugins && array.foreach( customPlugins, function ( plugin ) {
                plugin.parentNode.removeChild( plugin );
            } );
            window._data = data;
            array.foreach( querySelectorAll( ".cur-plugin > .item" ), function ( item ) {
                if ( !item.classList.contains( "title" ) && !item.classList.contains( "page-item" ) ) {
                    pluginsBorder.removeChild( item );
                }
            } );
            //  生成item和page上的组件
            object.foreach( _data, function ( id, data ) {
                //
                data.wid = id;
                if ( data.name in _dataMap ) {
                    addPluginFunc( _dataMap[data.name], data );
                }
                else {
                    addPluginFunc( {
                        title : data.name,
                        notSupportAttr : [],
                        src : data.name
                    }, data );
                }
            } );
            pageItem.click();
        }

        querySelector( ".import-data" ).onclick = function () {
            var border = $( "div", {
                        css : {
                            position : "absolute",
                            top : "0",
                            left : "0",
                            bottom : "0",
                            right : 0,
                            "z-index" : 100,
                            background : "rgba(0,0,0,0.9)"
                        }
                    }, document.body ),
                    textarea = $( "textarea", {
                        css : {
                            width : "500px",
                            top : "100px",
                            bottom : "200px",
                            background : "white",
                            "overflow-y" : "auto",
                            position : "absolute",
                            left : "50%",
                            "margin-left" : "-250px"
                        }
                    }, border ),
                    btn = $( "div", {
                        css : {
                            width : "70px",
                            height : "30px",
                            "line-height" : "30px",
                            "text-align" : "center",
                            position : "absolute",
                            left : "50%",
                            "margin-left" : "-35px",
                            bottom : "50px",
                            "background-color" : "white",
                            "border-radius" : "5px",
                            cursor : "pointer"
                        },
                        innerHTML : "确认"
                    }, border );

            btn.onclick = function () {
                if ( textarea.value.trim().length != 0 ) {
                    resetByData( JSON.parse( textarea.value ) );
                    curZuoPinName = null;
                }
                border.parentNode.removeChild( border );
                border = null;
            }

        };

        var zuopinWall = null,
                actHandle = null;

        querySelector( ".change.top-btn" ).onclick = function () {
            if ( zuopinWall ) {
                zuopinWall.classList.add( "show" );
            }
            else {
                zuopinWall = $( "div", {
                    classList : "loading",
                    css : {
                        position : "absolute",
                        top : 0,
                        left : 0,
                        right : 0,
                        bottom : 0,
                        "z-index" : 200,
                        "background" : "white"
                    }
                }, document.body );
                var xhr = new XMLHttpRequest();
                xhr.open( "get", "http://" + location.hostname + ":7474/get-cinema-list", true );
                xhr.send();
                xhr.onreadystatechange = function () {
                    if ( xhr.readyState == 4 && xhr.status == 200 ) {
                        var data = JSON.parse( xhr.responseText ).message;
                        if ( data.length == 0 ) {
                            alert( "你目前还没有其他作品，无法进行切换" );
                            document.body.removeChild( zuopinWall );
                            zuopinWall = null;
                        }
                        else {
                            var border = $( "div", {
                                css : {
                                    position : "absolute",
                                    top : "20%",
                                    left : "20%",
                                    right : "20%",
                                    bottom : "20%",
                                    "overflow-y" : "auto",
                                    "overflow-x" : "hidden"
                                }
                            }, zuopinWall );
                            var closeBtn = $( "div", {
                                innerHTML : "放弃",
                                css : {
                                    position : "absolute",
                                    top : "85%",
                                    left : "50%",
                                    "-webkit-transform" : "translate3d(-50%,-50%,0)",
                                    height : "40px",
                                    "line-height" : "40px",
                                    width : "80px",
                                    "border-radius" : "5px",
                                    background : "orange",
                                    color : "white",
                                    "text-align" : "center",
                                    "cursor" : "pointer"
                                }
                            }, zuopinWall );
                            closeBtn.onclick = function () {
                                document.body.removeChild( zuopinWall );
                                zuopinWall = null;
                            };
                            array.foreach( data, function ( zp ) {
                                setTimeout( function () {
                                    var item = $( "div", {
                                        css : {
                                            height : "30px",
                                            "line-height" : "30px",
                                            color : "#0e1242",
                                            cursor : "pointer",
                                            "text-align" : "center"
                                        },
                                        innerText : zp.name
                                    }, border );
                                    item.onclick = function () {
                                        var state = confirm( "确定要切换到这个作品吗？如果当前作品未保存会丢失" );
                                        if ( state ) {
                                            curZuoPinName = zp.name;
                                            resetByData( JSON.parse( zp.animate ) );
                                            closeBtn.click();
                                        }
                                        else {
                                            closeBtn.click();
                                        }
                                    }
                                }, 100 );
                            } );
                        }
                    }
                };
                xhr.onerror = function () {
                    alert( "网络或服务器出现故障，请联系管理员" );
                    setTimeout( function () {
                        zuopinWall.parentNode.removeChild( zuopinWall );
                        zuopinWall = null;
                    }, 4000 );
                }
            }
        };

        //　预览
        querySelector( ".act.top-btn" ).onclick = function () {
            actHandle && actHandle.destroy();
            actHandle = cinema.materialize( page, _data, function () {

            } );
        };

        // 保存
        querySelector( ".save.top-btn" ).onclick = function () {
            var wall = $( "div", {
                css : {
                    position : "absolute",
                    top : 0,
                    left : 0,
                    right : 0,
                    bottom : 0,
                    "z-index" : 200,
                    "background" : "rgba(0,0,0,0.98)"
                }
            }, document.body );
            if ( !curZuoPinName ) {
                // 如果没有作品名字，起个名字，然后insert
                var inputName = $( "input", {
                    css : {
                        width : "300px",
                        height : "50px",
                        "line-height" : "50px",
                        "font-size" : "22px",
                        "font-family" : "微软雅黑",
                        "out-line" : "none",
                        "border-radius" : "5px",
                        "text-align" : "center",
                        position : "absolute",
                        top : "50%",
                        left : "50%",
                        "border" : "none",
                        "-webkit-transform" : "translate3d(-50%,-50%,0)"
                    },
                    placeholder : "给作品起个名字吧~"
                }, wall );
                var closeBtn = $( "div", {
                    css : {
                        width : "300px",
                        height : "40px",
                        "line-height" : "40px",
                        "text-align" : "center",
                        background : "orange",
                        color : "white",
                        border : "none",
                        "border-radius" : "4px",
                        position : "absolute",
                        top : "50%",
                        left : "50%",
                        cursor : "pointer",
                        "-webkit-transform" : "translate3d(-50%,150px,0)"
                    },
                    innerText : "放弃"
                }, wall );

                closeBtn.onclick = function () {
                    document.body.removeChild( wall );
                    wall = null;
                };
                //　验证是否重名
                inputName.onblur = function () {
                    if ( inputName.value.trim().length != 0 ) {
                        var xhr1 = new XMLHttpRequest();
                        xhr1.open( "get", encodeURI( "http://" + location.hostname + ":7474/check-cinema-name?name=" + inputName.value.trim() ), true );
                        xhr1.send();
                        xhr1.onreadystatechange = function () {
                            if ( xhr1.readyState == 4 && xhr1.status == 200 ) {
                                var data = JSON.parse( xhr1.responseText );
                                if ( data.code == 200 ) {
                                    if ( data.message ) {
                                        // 已经被占用
                                        inputName.value = "";
                                        inputName.placeholder = "名字已经被占用";
                                    }
                                    else {
                                        // 没有被占用，使用之
                                        var fd = new FormData();
                                        fd.append( "data", JSON.stringify( _data ) );
                                        fd.append( "name", inputName.value.trim() );
                                        var xhr = new XMLHttpRequest();
                                        xhr.open( "post", "http://" + location.hostname + ":7474/insert-cinema-data", true );
                                        xhr.send( fd );
                                        xhr.onreadystatechange = function () {
                                            if ( xhr.readyState == 4 && xhr.status == 200 ) {
                                                var d2 = JSON.parse( xhr.responseText );
                                                if ( d2.code == 200 ) {
                                                    closeBtn.click();
                                                }
                                                else {
                                                    closeBtn.click();
                                                    alert( "操作失败" );
                                                }
                                            }
                                        };
                                        xhr.onerror = function () {
                                            console.log( "err" )
                                        };
                                    }
                                }
                                else {
                                    inputName.value = "";
                                    inputName.placeholder = "故障";
                                }
                            }
                        };
                        xhr1.onerror = function () {
                            inputName.value = "";
                            inputName.placeholder = "故障";
                            console.log( "err" );
                        };
                    }
                }
            }
            else {
                // 如果有作品名字，不需要在起名字了，直接update
                var fd = new FormData();
                fd.append( "data", JSON.stringify( _data ) );
                fd.append( "name", curZuoPinName );
                var xhr2 = new XMLHttpRequest();
                xhr2.open( "post", "http://" + location.hostname + ":7474/save-cinema-data", true );
                xhr2.send( fd );
                xhr2.onreadystatechange = function () {
                    if ( xhr2.readyState == 4 && xhr2.status == 200 ) {
                        var d3 = JSON.parse( xhr2.responseText );
                        if ( d3.code == 200 ) {
                            document.body.removeChild( wall );
                            wall = null;
                            alert( "保存成功" );
                        }
                        else {
                            document.body.removeChild( wall );
                            wall = null;
                            alert( "操作失败" );
                        }
                    }
                };
                xhr2.onerror = function () {
                    console.log( "err" )
                };
            }
        }

    } );
</script>
</body>
</html>